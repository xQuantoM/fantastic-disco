<!DOCTYPE html>
<html>
<head>
    <title>My AI Workbench</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.2.6/purify.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        :root {
            --background-color: #212121; --chat-log-bg: #212121; --user-bubble-bg: #5c28f2; --ai-bubble-bg: #3e3e42; --text-color: #ececec; --input-bg: #3e3e42; --button-bg: #555; --border-color: #555; --accent-color: #03dac6;
        }
        html, body { height: 100%; overflow: hidden; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: var(--background-color); color: var(--text-color); margin: 0; display: flex; justify-content: center; }
        #app-container { display: flex; flex-direction: column; width: 100%; max-width: 820px; height: 100vh; }
        header { flex-shrink: 0; display: flex; justify-content: space-between; align-items: center; padding: 10px 20px; border-bottom: 1px solid var(--border-color); }
        #user-info { font-size: 14px; color: #888; }
        #login-btn { padding: 8px 16px; font-size: 14px; border: 1px solid var(--user-bubble-bg); background-color: var(--user-bubble-bg); color: white; border-radius: 8px; cursor: pointer; font-weight: bold; }
        #tool-switcher { display: flex; border: 1px solid var(--border-color); border-radius: 10px; overflow: hidden; }
        .tool-tab { padding: 8px 20px; font-size: 16px; background-color: transparent; color: var(--text-color); border: none; cursor: pointer; }
        .tool-tab.active { background-color: var(--input-bg); }
        #tool-container { flex-grow: 1; display: flex; position: relative; overflow: hidden; }
        .tool { width: 100%; height: 100%; display: none; flex-direction: column; }
        .tool.active { display: flex; }
        #chat-tool { position: relative; }
        #chat-log { flex-grow: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 20px; scroll-behavior: smooth; }
        #prompt-area { flex-shrink: 0; padding: 20px; border-top: 1px solid var(--border-color); background-color: var(--background-color); }
        #prompt-container { display: flex; align-items: flex-end; background-color: var(--input-bg); border: 1px solid var(--border-color); border-radius: 24px; padding: 10px; gap: 10px; }
        #prompt { flex-grow: 1; background-color: transparent; color: var(--text-color); border: none; outline: none; resize: none; font-family: inherit; font-size: 16px; max-height: 200px; overflow-y: auto; line-height: 1.5; }
        #submitBtn { display: flex; justify-content: center; align-items: center; width: 36px; height: 36px; border: none; background-color: var(--button-bg); color: var(--text-color); border-radius: 50%; cursor: pointer; flex-shrink: 0; }
        #submitBtn.active { background-color: var(--user-bubble-bg); }
        #submitBtn svg { width: 20px; height: 20px; margin-left: 2px; }
        .message-bubble { max-width: 85%; padding: 15px; line-height: 1.6; position: relative; word-wrap: break-word; }
        .user-bubble { background-color: var(--user-bubble-bg); color: white; align-self: flex-end; border-radius: 20px 20px 3px 20px; }
        .ai-bubble { background-color: var(--ai-bubble-bg); color: var(--text-color); align-self: flex-start; border-radius: 20px 20px 20px 3px; }
        #image-tool { padding: 20px; } #image-prompt-container { display: flex; } #image-prompt { flex-grow: 1; padding: 14px; font-size: 16px; border: 1px solid var(--border-color); border-radius: 24px 0 0 24px; background-color: var(--input-bg); color: var(--text-color); outline: none; } #image-generate-btn { padding: 10px 20px; font-size: 16px; border: 1px solid var(--accent-color); background-color: var(--accent-color); color: #121212; font-weight: bold; border-radius: 0 24px 24px 0; cursor: pointer; } #image-display-area { flex-grow: 1; overflow-y: auto; border: 1px solid var(--border-color); padding: 10px; background-color: #1e1e1e; border-radius: 8px; margin-top: 15px; display: flex; flex-wrap: wrap; gap: 10px; align-content: flex-start; }
    </style>
</head>
<body>
    <div id="app-container">
        <header>
            <div id="user-info">Checking status...</div>
            <div id="tool-switcher">
                <button class="tool-tab active" data-tool="chat-tool">Chat</button>
                <button class="tool-tab" data-tool="image-tool">Image</button>
            </div>
            <button id="login-btn">Login</button>
        </header>
        <div id="tool-container">
            <div id="chat-tool" class="tool active">
                <div style="text-align: center; padding: 10px; border-bottom: 1px solid var(--border-color);">
                    <select id="model-selector">
                        <option value="gpt-4o" selected>GPT-4o</option>
                        <option value="gpt-4o-mini">GPT-4o Mini</option>
                        <option value="gpt-4.1">GPT-4.1</option>
                        <option value="gpt-4.1-mini">GPT-4.1 Mini</option>
                        <option value="gpt-4.1-nano">GPT-4.1 Nano</option>
                        <option value="gpt-4.5-preview">GPT-4.5 Preview</option>
                        <option value="o1">o1</option>
                        <option value="o1-mini">o1-mini</option>
                        <option value="o1-pro">o1-pro</option>
                        <option value="o3">o3</option>
                        <option value="o3-mini">o3-mini</option>
                        <option value="o4-mini">o4-mini</option>
                    </select>
                </div>
                <div id="chat-log"></div>
            </div>
            <div id="image-tool" class="tool">
                <div id="image-prompt-container">
                    <input type="text" id="image-prompt" placeholder="A photo of a cat astronaut on Mars...">
                    <button id="image-generate-btn">Generate</button>
                </div>
                <div id="image-display-area"></div>
            </div>
        </div>
        <div id="prompt-area">
            <div id="prompt-container">
                <textarea id="prompt" placeholder="Please log in to start chatting..." rows="1" disabled></textarea>
                <button id="submitBtn">
                    <svg viewBox="0 0 24 24" fill="currentColor"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"></path></svg>
                </button>
            </div>
        </div>
    </div>

    <script src="https://js.puter.com/v2/"></script>
    <script>
        // --- Get All Elements ---
        const loginBtn = document.getElementById('login-btn');
        const userInfo = document.getElementById('user-info');
        const chatLog = document.getElementById('chat-log');
        const submitBtn = document.getElementById('submitBtn');
        const promptInput = document.getElementById('prompt');
        const modelSelector = document.getElementById('model-selector');
        const toolTabs = document.querySelectorAll('.tool-tab');
        const imageGenerateBtn = document.getElementById('image-generate-btn');
        const imagePromptInput = document.getElementById('image-prompt');
        const imageDisplayArea = document.getElementById('image-display-area');
        
        const emptyStateHTML = `<div id="empty-state" style="flex-grow: 1; display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center;"><h2 style="color: #888; font-size: 24px; font-weight: 500;">Please log in to begin.</h2></div>`;

        // --- Functions ---
        function initializeChat() { chatLog.innerHTML = emptyStateHTML; }

        function addBubble(text, type) {
            const bubble = document.createElement('div');
            bubble.className = `message-bubble ${type}-bubble`;
            const contentDiv = document.createElement('div');
            contentDiv.className = 'message-content';
            contentDiv.textContent = text;
            bubble.appendChild(contentDiv);
            chatLog.appendChild(bubble);
            chatLog.scrollTop = chatLog.scrollHeight;
            return bubble;
        }

        async function submitPrompt() {
            const userPrompt = promptInput.value.trim();
            if (!userPrompt) return;

            const emptyState = document.getElementById('empty-state');
            if (emptyState) emptyState.remove();

            addBubble(userPrompt, 'user');
            promptInput.value = ''; promptInput.style.height = 'auto'; submitBtn.classList.remove('active');

            const aiBubble = addBubble("Thinking...", 'ai');
            const contentContainer = aiBubble.querySelector('.message-content');
            let fullResponse = "";

            try {
                const selectedModel = modelSelector.value;
                const responseStream = await puter.ai.chat(userPrompt, { stream: true, model: selectedModel });
                contentContainer.textContent = ''; // Clear "Thinking..."
                for await (const part of responseStream) {
                    const chunk = part?.text || ''; 
                    fullResponse += chunk;
                    contentContainer.innerHTML = DOMPurify.sanitize(marked.parse(fullResponse));
                }
            } catch (error) {
                console.error("API Error:", error);
                contentContainer.textContent = `API Error: ${error.message}`;
            }
        }

        async function updateUserStatus() {
            if (puter.auth.isSignedIn()) {
                const user = await puter.auth.getUser();
                userInfo.textContent = `Logged in: ${user.username}`;
                loginBtn.textContent = 'Logout';
                promptInput.disabled = false;
                promptInput.placeholder = 'Ask anything...';
                imagePromptInput.disabled = false;
                imageGenerateBtn.disabled = false;
                imagePromptInput.placeholder = 'A photo of a cat astronaut on Mars...';
                const emptyState = document.getElementById('empty-state');
                if (emptyState) emptyState.remove();
            } else {
                userInfo.textContent = 'Not Logged In';
                loginBtn.textContent = 'Login';
                promptInput.disabled = true;
                promptInput.placeholder = 'Please log in to start chatting...';
                imagePromptInput.disabled = true;
                imageGenerateBtn.disabled = true;
                imagePromptInput.placeholder = 'Please log in to generate images...';
                initializeChat();
            }
        }

        async function handleImagePrompt() {
            try {
                if(!puter.auth.isSignedIn()){
                    await puter.auth.signIn();
                    await updateUserStatus();
                    if(!puter.auth.isSignedIn()) return; // If user cancelled login
                }
                const imagePrompt = imagePromptInput.value;
                if (!imagePrompt) return;
                const loadingDiv = document.createElement('div'); 
                loadingDiv.className = 'loading-indicator';
                loadingDiv.textContent = `Generating "${imagePrompt}"...`; 
                imageDisplayArea.prepend(loadingDiv);
                imagePromptInput.value = '';
                const imageElement = await puter.ai.txt2img(imagePrompt);
                imageElement.className = 'generated-image'; 
                loadingDiv.replaceWith(imageElement);
            } catch (error) {
                console.error("Image Gen Error:", error);
                const errorDiv = document.createElement('div');
                errorDiv.className = 'image-error-message'; // Add a class for potential styling
                errorDiv.style.color = 'red'; // Basic styling for visibility
                errorDiv.style.width = '100%'; // Ensure it takes full width
                errorDiv.style.textAlign = 'center'; // Center the text
                errorDiv.style.padding = '10px'; // Add some padding
                errorDiv.textContent = `Error generating image: ${error.message}`;
                imageDisplayArea.prepend(errorDiv);

                // Also, ensure any existing loading indicator is removed if an error occurs.
                const existingLoadingDiv = document.querySelector('.loading-indicator');
                if (existingLoadingDiv) {
                    existingLoadingDiv.remove();
                }
            }
        }

        // --- Event Listeners ---
        loginBtn.addEventListener('click', async () => {
            if (puter.auth.isSignedIn()) {
                await puter.auth.logout();
            } else {
                await puter.auth.signIn();
            }
            updateUserStatus();
        });

        toolTabs.forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.tool-tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tool').forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                document.getElementById(tab.dataset.tool).classList.add('active');
            });
        });

        promptInput.addEventListener('input', () => {
            promptInput.style.height = 'auto';
            promptInput.style.height = (promptInput.scrollHeight) + 'px';
            if (promptInput.value.trim() !== '') { submitBtn.classList.add('active'); } else { submitBtn.classList.remove('active'); }
        });

        promptInput.addEventListener('keydown', (event) => { if (event.key === 'Enter' && !event.shiftKey) { event.preventDefault(); submitPrompt(); } });
        submitBtn.addEventListener('click', submitPrompt);
        imageGenerateBtn.addEventListener('click', handleImagePrompt);

        // --- Initial Load ---
        (async () => {
            await updateUserStatus();
        })();
    </script>
</body>
</html>
